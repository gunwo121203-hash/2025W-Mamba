# NeuroMamba ì½”ë“œ êµ¬ì¡° ë¶„ì„

## ğŸ“‹ ê°œìš”

NeuroMambaëŠ” fMRI(ê¸°ëŠ¥ì  ìê¸°ê³µëª…ì˜ìƒ) ë°ì´í„°ë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•œ **Mamba ê¸°ë°˜ ë”¥ëŸ¬ë‹ ëª¨ë¸**ì…ë‹ˆë‹¤. ì´ í”„ë¡œì íŠ¸ëŠ” PyTorch Lightning í”„ë ˆì„ì›Œí¬ë¥¼ ê¸°ë°˜ìœ¼ë¡œ êµ¬ì¶•ë˜ì–´ ìˆìœ¼ë©°, ì‚¬ì „í•™ìŠµ(Pretraining)ê³¼ ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ íƒœìŠ¤í¬(Downstream Task) ëª¨ë‘ë¥¼ ì§€ì›í•©ë‹ˆë‹¤.

---

## ğŸ—‚ï¸ ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
NeuroMamba-main/
â”œâ”€â”€ project/
â”‚   â”œâ”€â”€ main.py                          # ë©”ì¸ ì§„ì…ì 
â”‚   â”œâ”€â”€ check_flops.py                   # FLOPS ê³„ì‚° ìŠ¤í¬ë¦½íŠ¸
â”‚   â”œâ”€â”€ deepspeed_profile.py             # DeepSpeed í”„ë¡œíŒŒì¼ë§
â”‚   â””â”€â”€ module/
â”‚       â”œâ”€â”€ __init__.py                  # ëª¨ë“ˆ ì´ˆê¸°í™”
â”‚       â”œâ”€â”€ pl_classifier.py             # PyTorch Lightning ë¶„ë¥˜ê¸°
â”‚       â”œâ”€â”€ models/
â”‚       â”‚   â”œâ”€â”€ __init__.py
â”‚       â”‚   â”œâ”€â”€ fmamba.py                # FMamba í•µì‹¬ ëª¨ë¸
â”‚       â”‚   â”œâ”€â”€ load_model.py            # ëª¨ë¸ ë¡œë”© ìœ í‹¸ë¦¬í‹°
â”‚       â”‚   â””â”€â”€ utils.py                 # ëª¨ë¸ ìœ í‹¸ë¦¬í‹°
â”‚       â””â”€â”€ utils/
â”‚           â”œâ”€â”€ __init__.py
â”‚           â”œâ”€â”€ data_module.py           # ë°ì´í„° ëª¨ë“ˆ
â”‚           â”œâ”€â”€ data_utils.py            # ë°ì´í„° ìœ í‹¸ë¦¬í‹°
â”‚           â”œâ”€â”€ losses.py                # ì†ì‹¤ í•¨ìˆ˜
â”‚           â”œâ”€â”€ lr_scheduler.py          # í•™ìŠµë¥  ìŠ¤ì¼€ì¤„ëŸ¬
â”‚           â”œâ”€â”€ metrics.py               # í‰ê°€ ë©”íŠ¸ë¦­
â”‚           â”œâ”€â”€ neptune_utils.py         # Neptune ë¡œê¹… ìœ í‹¸
â”‚           â”œâ”€â”€ parser.py                # ì¸ì íŒŒì„œ ìœ í‹¸
â”‚           â”œâ”€â”€ seed_creation.py         # ì‹œë“œ ìƒì„±
â”‚           â””â”€â”€ data_preprocess_and_load/
â”‚               â”œâ”€â”€ __init__.py
â”‚               â”œâ”€â”€ datasets.py          # ë°ì´í„°ì…‹ í´ë˜ìŠ¤
â”‚               â”œâ”€â”€ datasets_hdf5.py     # HDF5 ë°ì´í„°ì…‹
â”‚               â”œâ”€â”€ preprocessing.py     # ì „ì²˜ë¦¬ ìŠ¤í¬ë¦½íŠ¸
â”‚               â”œâ”€â”€ preprocessing_HCP_v2.py
â”‚               â”œâ”€â”€ convert_data_into_hdf5.py
â”‚               â”œâ”€â”€ convert_data_into_hdf5_revised.py
â”‚               â”œâ”€â”€ convert_data_into_hdf5_revised_nogzip.py
â”‚               â”œâ”€â”€ convert_gziph5_into_hdf5.py
â”‚               â””â”€â”€ check_and_clean_hdf5.py
â”œâ”€â”€ sample_scripts/                      # ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ ì˜ˆì œ
â”œâ”€â”€ notebooks/                           # ë¶„ì„ ë…¸íŠ¸ë¶
â”œâ”€â”€ assets/                              # ì•„í‚¤í…ì²˜ ì´ë¯¸ì§€
â”œâ”€â”€ requirements.txt                     # ì˜ì¡´ì„±
â””â”€â”€ README.md
```

---

## ğŸ”„ ì „ì²´ íë¦„ë„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              main.py (ì§„ì…ì )                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. ArgumentParserë¡œ CLI ì¸ì íŒŒì‹±                                           â”‚
â”‚  2. Logger ì„¤ì • (TensorBoard/Neptune)                                       â”‚
â”‚  3. DataModule ì´ˆê¸°í™” (fMRIDataModule)                                       â”‚
â”‚  4. Callbacks ì„¤ì • (ModelCheckpoint, LRMonitor, EarlyStopping)              â”‚
â”‚  5. Trainer ìƒì„± (PyTorch Lightning)                                        â”‚
â”‚  6. Model ìƒì„± (LitClassifier)                                              â”‚
â”‚  7. í•™ìŠµ/í…ŒìŠ¤íŠ¸ ì‹¤í–‰                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         pl_classifier.py (LitClassifier)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ PyTorch Lightning Module ìƒì†                                            â”‚
â”‚  â€¢ ëª¨ë¸ ì´ˆê¸°í™” (FMamba + Output Head)                                       â”‚
â”‚  â€¢ forward(), training_step(), validation_step() ë“± ì •ì˜                    â”‚
â”‚  â€¢ configure_optimizers(): AdamW/SGD + CosineAnnealing ìŠ¤ì¼€ì¤„ëŸ¬             â”‚
â”‚  â€¢ ì‚¬ì „í•™ìŠµ ëª¨ë“œ: Contrastive, MIM (Masked Image Modeling), Autoregressive  â”‚
â”‚  â€¢ ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ ëª¨ë“œ: Classification, Regression                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â–¼                                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     fmamba.py (FMamba)       â”‚           â”‚    data_module.py (fMRIDataModule)â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ PatchEmbed: 4D ì´ë¯¸ì§€ë¥¼    â”‚           â”‚  â€¢ ë‹¤ì¤‘ ë°ì´í„°ì…‹ ì§€ì› (S1200,    â”‚
â”‚    íŒ¨ì¹˜ë¡œ ë¶„í•                â”‚           â”‚    ABCD, UKB, HBN, ABIDE ë“±)     â”‚
â”‚  â€¢ ìœ„ì¹˜ ì¸ì½”ë”© (NeRF, CPE,   â”‚           â”‚  â€¢ Train/Val/Test ë¶„í•            â”‚
â”‚    Fourier Features)         â”‚           â”‚  â€¢ Stratified/PSM ìƒ˜í”Œë§         â”‚
â”‚  â€¢ Mamba2 ë ˆì´ì–´ ìŠ¤íƒ        â”‚           â”‚  â€¢ DataLoader ìƒì„±               â”‚
â”‚  â€¢ RMSNorm ì •ê·œí™”            â”‚           â”‚  â€¢ ì…ë ¥ ìŠ¤ì¼€ì¼ë§ ì˜µì…˜            â”‚
â”‚  â€¢ ì¶œë ¥ ë ˆì´ì–´               â”‚           â”‚    (minmax, znorm ë“±)            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚                                               â”‚
              â–¼                                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Classification Heads        â”‚           â”‚    datasets.py / datasets_hdf5.py â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ fmamba_mlp: í‰ê·  í’€ë§ +   â”‚           â”‚  â€¢ BaseDataset: ê³µí†µ ë¡œì§        â”‚
â”‚    Linear                    â”‚           â”‚  â€¢ ë°ì´í„°ì…‹ë³„ í´ë˜ìŠ¤:            â”‚
â”‚  â€¢ fmamba_conv_mlp: Conv1D   â”‚           â”‚    - S1200 (HCP)                 â”‚
â”‚    ë¸”ë¡ + í’€ë§               â”‚           â”‚    - ABCD                        â”‚
â”‚  â€¢ fmamba_mamba_head: Mamba  â”‚           â”‚    - UKB                         â”‚
â”‚    ë ˆì´ì–´ + ë§ˆì§€ë§‰ í† í°      â”‚           â”‚    - HBN, ABIDE, ADNI            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚  â€¢ ì‹œí€€ìŠ¤ ë¡œë”© & ìŠ¤ì¼€ì¼ë§        â”‚
                                           â”‚  â€¢ íŒ¨ë”© ì²˜ë¦¬ (96x96x96)          â”‚
                                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ íŒŒì¼ë³„ ìƒì„¸ ë¶„ì„

### ğŸ”¹ í•µì‹¬ ì‹¤í–‰ íŒŒì¼

#### `project/main.py`
**ì—­í• **: ì „ì²´ í•™ìŠµ/í…ŒìŠ¤íŠ¸ íŒŒì´í”„ë¼ì¸ì˜ ì§„ì…ì 

**ì£¼ìš” ê¸°ëŠ¥**:
- CLI ì¸ì íŒŒì‹± (ArgumentParser)
- Logger ì„¤ì • (TensorBoard ë˜ëŠ” Neptune)
- ë°ì´í„° ëª¨ë“ˆ ì´ˆê¸°í™”
- ì½œë°± ì„¤ì • (ModelCheckpoint, LRMonitor, EarlyStopping)
- PyTorch Lightning Trainer ìƒì„±
- ëª¨ë¸ ê°€ì¤‘ì¹˜ ë¡œë”© (ì‚¬ì „í•™ìŠµ ê°€ì¤‘ì¹˜ ë˜ëŠ” ì²´í¬í¬ì¸íŠ¸)
- íŠ¹ì„± ì¶”ì¶œê¸° ë™ê²° ì˜µì…˜
- í•™ìŠµ/í…ŒìŠ¤íŠ¸ ì‹¤í–‰

**í•µì‹¬ ì½”ë“œ íë¦„**:
```python
cli_main()
â”œâ”€â”€ ì¸ì íŒŒì‹±
â”œâ”€â”€ Logger ì„¤ì • (Neptune/TensorBoard)
â”œâ”€â”€ DataModule ìƒì„±
â”œâ”€â”€ Callbacks ì„¤ì •
â”œâ”€â”€ Trainer ìƒì„±
â”œâ”€â”€ Model (LitClassifier) ìƒì„±
â”œâ”€â”€ ì‚¬ì „í•™ìŠµ ê°€ì¤‘ì¹˜ ë¡œë”© (ì„ íƒì )
â””â”€â”€ trainer.fit() / trainer.test() ì‹¤í–‰
```

---

#### `project/check_flops.py`
**ì—­í• **: ëª¨ë¸ì˜ FLOPS (Floating Point Operations) ê³„ì‚°

**ì£¼ìš” ê¸°ëŠ¥**:
- DeepSpeed í”„ë¡œíŒŒì¼ëŸ¬ë¥¼ ì‚¬ìš©í•œ FLOPS ì¸¡ì •
- ì—í­ë‹¹ ì—°ì‚°ëŸ‰ ê³„ì‚°
- í† í° ìˆ˜ ê³„ì‚°

---

#### `project/deepspeed_profile.py`
**ì—­í• **: DeepSpeedë¥¼ í™œìš©í•œ ëª¨ë¸ í”„ë¡œíŒŒì¼ë§

**ì£¼ìš” ê¸°ëŠ¥**:
- Intel XPU (Aurora ìŠˆí¼ì»´í“¨í„°) ì§€ì›
- ëª¨ë¸ í”„ë¡œíŒŒì¼ë§ ë° ì„±ëŠ¥ ì¸¡ì •
- ë°°ì¹˜ë‹¹/ì—í­ë‹¹ FLOPS ê³„ì‚°

---

### ğŸ”¹ ëª¨ë¸ ê´€ë ¨ íŒŒì¼

#### `project/module/pl_classifier.py` (LitClassifier)
**ì—­í• **: PyTorch Lightning ê¸°ë°˜ ë©”ì¸ í•™ìŠµ ëª¨ë“ˆ

**ì£¼ìš” ê¸°ëŠ¥**:
1. **ëª¨ë¸ ì´ˆê¸°í™”**
   - FMamba ë°±ë³¸ ëª¨ë¸ ë¡œë”©
   - ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ íƒœìŠ¤í¬ì— ë”°ë¥¸ ì¶œë ¥ í—¤ë“œ ì„¤ì •
   - MuTransfer (í•˜ì´í¼íŒŒë¼ë¯¸í„° ì „ì´) ì§€ì›

2. **ì‚¬ì „í•™ìŠµ ëª¨ë“œ**
   - Contrastive Learning (NTXent Loss)
   - Masked Image Modeling (SimMIM)
   - Autoregressive Modeling (ë‹¤ìŒ í”„ë ˆì„ ì˜ˆì¸¡)

3. **ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ íƒœìŠ¤í¬**
   - Classification: ì„±ë³„ ì˜ˆì¸¡, ì§ˆë³‘ ì§„ë‹¨ ë“±
   - Regression: ë‚˜ì´ ì˜ˆì¸¡, ì§€ëŠ¥ ì ìˆ˜ ì˜ˆì¸¡ ë“±

4. **í•™ìŠµ ê´€ë ¨**
   - ë°ì´í„° ì¦ê°• (Affine, Gaussian Noise, Smooth)
   - ì†ì‹¤ ê³„ì‚° ë° ë©”íŠ¸ë¦­ í‰ê°€
   - ì˜µí‹°ë§ˆì´ì €/ìŠ¤ì¼€ì¤„ëŸ¬ ì„¤ì •

**í´ë˜ìŠ¤ êµ¬ì¡°**:
```python
class LitClassifier(pl.LightningModule):
    â”œâ”€â”€ __init__(): ëª¨ë¸/í—¤ë“œ ì´ˆê¸°í™”
    â”œâ”€â”€ forward(): ìˆœì „íŒŒ
    â”œâ”€â”€ augment(): ë°ì´í„° ì¦ê°•
    â”œâ”€â”€ _compute_logits(): ì˜ˆì¸¡ ê³„ì‚°
    â”œâ”€â”€ _calculate_loss(): ì†ì‹¤ ê³„ì‚°
    â”œâ”€â”€ _evaluate_metrics(): ë©”íŠ¸ë¦­ í‰ê°€
    â”œâ”€â”€ training_step(): í•™ìŠµ ë‹¨ê³„
    â”œâ”€â”€ validation_step(): ê²€ì¦ ë‹¨ê³„
    â”œâ”€â”€ test_step(): í…ŒìŠ¤íŠ¸ ë‹¨ê³„
    â””â”€â”€ configure_optimizers(): ì˜µí‹°ë§ˆì´ì € ì„¤ì •
```

---

#### `project/module/models/fmamba.py`
**ì—­í• **: FMamba í•µì‹¬ ëª¨ë¸ ì•„í‚¤í…ì²˜ ì •ì˜

**ì£¼ìš” ì»´í¬ë„ŒíŠ¸**:

1. **ìœ„ì¹˜ ì¸ì½”ë”© (Positional Encoding)**
   - `Embedder`: ì¢Œí‘œ ì„ë² ë”© ë˜í¼
   - `CoordinateEmbedder`: ì—°ì† ì¢Œí‘œ ì„ë² ë”©
     - Fourier Features
     - NeRF ìŠ¤íƒ€ì¼ ì„ë² ë”©
     - Continuous Position Embedding (CPE)

2. **PatchEmbed**
   - 4D fMRI ì´ë¯¸ì§€ë¥¼ íŒ¨ì¹˜ë¡œ ë¶„í• 
   - ì„ í˜• í”„ë¡œì ì…˜ìœ¼ë¡œ ì„ë² ë”©
   - ìœ„ì¹˜ ì„ë² ë”© ì¶”ê°€
   - ë‡Œ ì˜ì—­ë§Œ ì„ íƒí•˜ëŠ” ë§ˆìŠ¤í‚¹ ì˜µì…˜

3. **FMamba (ë©”ì¸ ëª¨ë¸)**
   ```python
   class FMamba(nn.Module):
       â”œâ”€â”€ embedder (PatchEmbed)
       â”œâ”€â”€ mamba_layers (Mamba2 ë¸”ë¡ Nê°œ)
       â”‚   â””â”€â”€ RMSNorm â†’ Mamba2 â†’ Dropout
       â”œâ”€â”€ norm (RMSNorm)
       â””â”€â”€ output_layer (Linear)
   ```

4. **ë¶„ë¥˜ í—¤ë“œë“¤**
   - `fmamba_mlp`: í‰ê·  í’€ë§ + Linear
   - `fmamba_conv_mlp`: Conv1D ë¸”ë¡ë“¤ + í’€ë§ + Linear
   - `fmamba_mamba_head`: Mamba ë ˆì´ì–´ + ë§ˆì§€ë§‰ í† í° ì¶œë ¥
   - `fmamba_mamba_head_finalnorm`: ìœ„ì™€ ë™ì¼ + ìµœì¢… ì •ê·œí™”

**ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨**:
```
Input: (B, C, D, H, W, T)
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  PatchEmbed â”‚ â†’ (B, num_patches, embed_dim)
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  N Ã— Mamba Block        â”‚
    â”‚  â”œâ”€ RMSNorm             â”‚
    â”‚  â”œâ”€ Mamba2              â”‚ Ã— num_layers
    â”‚  â”œâ”€ Dropout             â”‚
    â”‚  â””â”€ Residual Connection â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   RMSNorm   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚Output Layer â”‚ â†’ (B, num_patches, orig_size) [ì‚¬ì „í•™ìŠµ]
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   ë˜ëŠ” Classification Headë¡œ ì „ë‹¬ [ë‹¤ìš´ìŠ¤íŠ¸ë¦¼]
```

---

#### `project/module/models/load_model.py`
**ì—­í• **: ëª¨ë¸ ì´ë¦„ì— ë”°ë¥¸ ëª¨ë¸ ê°ì²´ ìƒì„±

**ì§€ì› ëª¨ë¸**:
- `fmamba`: ê¸°ë³¸ FMamba ëª¨ë¸
- `fmamba_mlp`: MLP ë¶„ë¥˜ í—¤ë“œ
- `fmamba_conv_mlp`: Conv1D ë¶„ë¥˜ í—¤ë“œ
- `fmamba_mamba_head`: Mamba ê¸°ë°˜ ë¶„ë¥˜ í—¤ë“œ
- `fmamba_mamba_head_fn`: ìµœì¢… ì •ê·œí™” í¬í•¨ Mamba í—¤ë“œ

---

#### `project/module/models/utils.py`
**ì—­í• **: ëª¨ë¸ ê´€ë ¨ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜

**ì£¼ìš” í•¨ìˆ˜**:
- `datestamp()`: íƒ€ì„ìŠ¤íƒ¬í”„ ìƒì„±
- `reproducibility()`: ì¬í˜„ì„±ì„ ìœ„í•œ ì‹œë“œ ì„¤ì •
- `sort_args()`: ì¸ì ì •ë ¬
- `args_to_text()`: ì¸ìë¥¼ í…ìŠ¤íŠ¸ë¡œ ì €ì¥

---

### ğŸ”¹ ë°ì´í„° ê´€ë ¨ íŒŒì¼

#### `project/module/utils/data_module.py` (fMRIDataModule)
**ì—­í• **: PyTorch Lightning DataModuleë¡œ ë°ì´í„° ë¡œë”© ê´€ë¦¬

**ì£¼ìš” ê¸°ëŠ¥**:
1. **ë°ì´í„°ì…‹ ì§€ì›**
   - S1200 (HCP 1200 Subjects)
   - ABCD
   - UKB (UK Biobank)
   - HBN
   - ABIDE
   - Dummy (í…ŒìŠ¤íŠ¸ìš©)

2. **ë°ì´í„° ë¶„í• **
   - Train/Validation/Test ë¶„í• 
   - ê³„ì¸µí™” ë¶„í•  (Stratified Split)
   - ì €ì¥ëœ ë¶„í•  íŒŒì¼ ë¡œë”©

3. **ìƒ˜í”Œë§ ì „ëµ**
   - Random Sampling
   - Balanced Undersampling
   - Stratified Sampling
   - PSM (Propensity Score Matching)

4. **ë©”íƒ€ë°ì´í„° ì²˜ë¦¬**
   - ì„±ë³„, ë‚˜ì´, ì§€ëŠ¥ ì ìˆ˜ ë“± íƒ€ê²Ÿ ì¶”ì¶œ
   - Subject Dictionary ìƒì„±

**í´ë˜ìŠ¤ êµ¬ì¡°**:
```python
class fMRIDataModule(pl.LightningDataModule):
    â”œâ”€â”€ __init__(): ì´ˆê¸°í™” ë° setup í˜¸ì¶œ
    â”œâ”€â”€ define_split_file_path(): ë¶„í•  íŒŒì¼ ê²½ë¡œ ì •ì˜
    â”œâ”€â”€ get_dataset(): ë°ì´í„°ì…‹ í´ë˜ìŠ¤ ë°˜í™˜
    â”œâ”€â”€ make_subject_dict(): í”¼í—˜ì-ë©”íƒ€ë°ì´í„° ë§¤í•‘
    â”œâ”€â”€ setup(): ë°ì´í„°ì…‹ ìƒì„±
    â”œâ”€â”€ train_dataloader(): í•™ìŠµ DataLoader
    â”œâ”€â”€ val_dataloader(): ê²€ì¦ DataLoader
    â””â”€â”€ test_dataloader(): í…ŒìŠ¤íŠ¸ DataLoader
```

---

#### `project/module/utils/data_preprocess_and_load/datasets.py`
**ì—­í• **: ë‹¤ì–‘í•œ fMRI ë°ì´í„°ì…‹ í´ë˜ìŠ¤ ì •ì˜ (PyTorch íŒŒì¼ ê¸°ë°˜)

**ì£¼ìš” í´ë˜ìŠ¤**:

1. **BaseDataset**: ëª¨ë“  ë°ì´í„°ì…‹ì˜ ê¸°ë³¸ í´ë˜ìŠ¤
   - ì‹œí€€ìŠ¤ ë¡œë”© (`load_sequence`)
   - ì…ë ¥ ìŠ¤ì¼€ì¼ë§ (`scale_input`)
   - ë°ì´í„° íŠœí”Œ ìƒì„±

2. **ë°ì´í„°ì…‹ë³„ í´ë˜ìŠ¤**:
   - `S1200`: HCP 1200 Subjects ë°ì´í„°
   - `ABCD`: ABCD ì—°êµ¬ ë°ì´í„°
   - `UKB`: UK Biobank ë°ì´í„°
   - `HBN`: Healthy Brain Network ë°ì´í„°
   - `ABIDE`: ABIDE I/II ë°ì´í„°
   - `ADNI`: ADNI ë°ì´í„°
   - `Dummy`: í…ŒìŠ¤íŠ¸ìš© ë”ë¯¸ ë°ì´í„°

3. **ConcatDataset**: ì—¬ëŸ¬ ë°ì´í„°ì…‹ ê²°í•©

**ë°ì´í„° ë¡œë”© íë¦„**:
```
__getitem__(index)
â”œâ”€â”€ data[index]ì—ì„œ ì •ë³´ ì¶”ì¶œ
â”œâ”€â”€ load_sequence(): í”„ë ˆì„ ë¡œë”©
â”‚   â”œâ”€â”€ frame_*.pt íŒŒì¼ë“¤ ë¡œë”©
â”‚   â”œâ”€â”€ torch.cat()ìœ¼ë¡œ ì—°ê²°
â”‚   â””â”€â”€ scale_input(): ì •ê·œí™”
â”œâ”€â”€ íŒ¨ë”© ì ìš© (96Ã—96Ã—96 ë§ì¶¤)
â””â”€â”€ ë”•ì…”ë„ˆë¦¬ ë°˜í™˜ {fmri_sequence, subject_name, target, TR, sex}
```

---

#### `project/module/utils/data_preprocess_and_load/datasets_hdf5.py`
**ì—­í• **: HDF5 í˜•ì‹ì˜ fMRI ë°ì´í„°ì…‹ (ê³ ì† ë¡œë”©ìš©)

**íŠ¹ì§•**:
- MPIë¥¼ í™œìš©í•œ ë¶„ì‚° ë°ì´í„° ì¸ë±ì‹±
- íŒŒì¼ í•¸ë“¤ ìºì‹±ìœ¼ë¡œ I/O ìµœì í™”
- HDF5 ì²­í¬ ê¸°ë°˜ íš¨ìœ¨ì  ìŠ¬ë¼ì´ì‹±

**í´ë˜ìŠ¤ êµ¬ì¡°** (datasets.pyì™€ ìœ ì‚¬í•˜ë‚˜ HDF5 íŠ¹í™”):
```python
class BaseDatasetHDF5(Dataset):
    â”œâ”€â”€ file_handles: íŒŒì¼ í•¸ë“¤ ìºì‹œ
    â”œâ”€â”€ _get_file_handle(): ì§€ì—° íŒŒì¼ ì—´ê¸°
    â”œâ”€â”€ load_sequence_hdf5(): HDF5ì—ì„œ ì‹œí€€ìŠ¤ ë¡œë”©
    â””â”€â”€ scale_input(): ì†ì„±ì—ì„œ ìŠ¤ì¼€ì¼ë§ ì •ë³´ ë¡œë”©
```

---

#### `project/module/utils/data_preprocess_and_load/preprocessing.py`
**ì—­í• **: NIfTI fMRI íŒŒì¼ì„ PyTorch í…ì„œë¡œ ë³€í™˜

**ì²˜ë¦¬ ê³¼ì •**:
```
NIfTI íŒŒì¼ (.nii.gz)
        â”‚
        â–¼
    MONAI LoadImageë¡œ ë¡œë”©
        â”‚
        â–¼
    ë°°ê²½ ì˜ì—­ ì œê±°/í¬ë¡­
        â”‚
        â–¼
    ì •ê·œí™” (z-norm ë˜ëŠ” minmax)
        â”‚
        â–¼
    í”„ë ˆì„ë³„ ì €ì¥ (frame_0.pt, frame_1.pt, ...)
```

---

#### `project/module/utils/data_preprocess_and_load/preprocessing_HCP_v2.py`
**ì—­í• **: HCP ë°ì´í„° ì „ìš© ì „ì²˜ë¦¬ (v2)

**ì°¨ì´ì **:
- HCP íŠ¹í™”ëœ íŒŒì¼ ê²½ë¡œ ì²˜ë¦¬
- ê¸€ë¡œë²Œ í†µê³„ ì €ì¥ (global_stats.pt)
  - valid_voxels, global_mean, global_std, global_max

---

#### `project/module/utils/data_preprocess_and_load/convert_data_into_hdf5*.py`
**ì—­í• **: PyTorch í…ì„œ íŒŒì¼ë“¤ì„ HDF5ë¡œ ë³€í™˜

**ë²„ì „ë³„ ì°¨ì´**:
- `convert_data_into_hdf5.py`: ê¸°ë³¸ ë²„ì „ (gzip ì••ì¶•)
- `convert_data_into_hdf5_revised.py`: ê°œì„ ëœ ë²„ì „
- `convert_data_into_hdf5_revised_nogzip.py`: ì••ì¶• ì—†ëŠ” ë²„ì „
- `convert_gziph5_into_hdf5.py`: gzip HDF5ë¥¼ ì¼ë°˜ HDF5ë¡œ ë³€í™˜

**MPI ë¶„ì‚° ì²˜ë¦¬**:
```python
# Rank 0: íŒŒì¼ ëª©ë¡ ìˆ˜ì§‘ ë° ë¸Œë¡œë“œìºìŠ¤íŠ¸
# ëª¨ë“  Rank: í• ë‹¹ëœ íŒŒì¼ë“¤ ì²˜ë¦¬
subjects_for_this_rank = all_subjects[rank::size]
```

---

### ğŸ”¹ ìœ í‹¸ë¦¬í‹° íŒŒì¼

#### `project/module/utils/data_utils.py`
**ì—­í• **: ë°ì´í„° ìƒ˜í”Œë§ ìœ í‹¸ë¦¬í‹°

**ì£¼ìš” í•¨ìˆ˜**:
1. **`_stratified_undersampling()`**: ê³„ì¸µí™” ì–¸ë”ìƒ˜í”Œë§
   - ì—°ì† ë³€ìˆ˜ binning (KBinsDiscretizer)
   - ê· í˜• ì¡íŒ í´ë˜ìŠ¤ ë¶„í¬ ìœ ì§€
   - íš¨ê³¼ í¬ê¸° ì¶œë ¥ ì˜µì…˜

2. **`_psm_undersampling()`**: Propensity Score Matching
   - psmpy ë¼ì´ë¸ŒëŸ¬ë¦¬ í™œìš©
   - ë¡œì§€ìŠ¤í‹± íšŒê·€ë¡œ ì„±í–¥ ì ìˆ˜ ê³„ì‚°
   - KNN ë§¤ì¹­

3. **`_calculate_and_print_effect_sizes()`**: íš¨ê³¼ í¬ê¸° ê³„ì‚°
   - ë²”ì£¼í˜•: Chi-squared ê²€ì •
   - ì—°ì†í˜•: t-ê²€ì •, Cohen's d

---

#### `project/module/utils/losses.py`
**ì—­í• **: ì†ì‹¤ í•¨ìˆ˜ ì •ì˜

**ì£¼ìš” í´ë˜ìŠ¤/í•¨ìˆ˜**:
1. **`NTXentLoss`**: Contrastive Learningìš© NT-Xent ì†ì‹¤
   - ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ê¸°ë°˜
   - ì˜¨ë„ íŒŒë¼ë¯¸í„° ì¡°ì ˆ

2. **`global_local_temporal_contrastive()`**: ì‹œê°„ì  ëŒ€ì¡° í•™ìŠµ

3. **`charbonnier_loss()`**: Charbonnier ì†ì‹¤

4. **`cauchy_loss()`**: Cauchy ì†ì‹¤

---

#### `project/module/utils/lr_scheduler.py`
**ì—­í• **: í•™ìŠµë¥  ìŠ¤ì¼€ì¤„ëŸ¬

**ì£¼ìš” í´ë˜ìŠ¤**:
1. **`WarmupCosineSchedule`**: ì›Œë°ì—… + ì½”ì‚¬ì¸ ê°ì‡ 

2. **`CosineAnnealingWarmUpRestarts`**: ì›Œë°ì—… + ì½”ì‚¬ì¸ ì¬ì‹œì‘
   ```
   LR
   â”‚    /\    /\    /\
   â”‚   /  \  /  \  /  \
   â”‚  /    \/    \/    \
   â”‚ /
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Step
     Warmup  Cycle1 Cycle2
   ```

3. **`CosineAnnealingWarmUpRestartsMup`**: MuTransferìš© ë²„ì „

---

#### `project/module/utils/metrics.py`
**ì—­í• **: í‰ê°€ ë©”íŠ¸ë¦­

**í•¨ìˆ˜**:
- `get_accuracy()`: ë‹¤ì¤‘ í´ë˜ìŠ¤ ì •í™•ë„
- `get_accuracy_binary()`: ì´ì§„ ë¶„ë¥˜ ì •í™•ë„

---

#### `project/module/utils/neptune_utils.py`
**ì—­í• **: Neptune ë¡œê¹… ìœ í‹¸ë¦¬í‹°

**í•¨ìˆ˜**:
- `load_ckpt()`: ì²´í¬í¬ì¸íŠ¸ ë¡œë”©
- `get_prev_args()`: ì´ì „ ì‹¤í—˜ì˜ í•˜ì´í¼íŒŒë¼ë¯¸í„° ë³µì›

---

#### `project/module/utils/parser.py`
**ì—­í• **: ì¸ì íŒŒì‹± ìœ í‹¸ë¦¬í‹°

**í•¨ìˆ˜**:
- `str2bool()`: ë¬¸ìì—´ì„ ë¶ˆë¦¬ì–¸ìœ¼ë¡œ ë³€í™˜

---

#### `project/module/utils/seed_creation.py`
**ì—­í• **: ë°ì´í„° ë¶„í• ìš© ì‹œë“œ ìƒì„± ë° ë¶„í•  ìƒì„±

**ìš©ë„**: ì¬í˜„ ê°€ëŠ¥í•œ Train/Val/Test ë¶„í•  ìƒì„±

---

## ğŸ¯ í•™ìŠµ ëª¨ë“œë³„ íë¦„

### 1ï¸âƒ£ ì‚¬ì „í•™ìŠµ (Pretraining)

#### Autoregressive Modeling
```
fMRI ì‹œí€€ìŠ¤ â†’ FMamba â†’ ë‹¤ìŒ í”„ë ˆì„ ì˜ˆì¸¡
Loss = MSE(ì˜ˆì¸¡ í”„ë ˆì„, ì‹¤ì œ ë‹¤ìŒ í”„ë ˆì„)
```

#### Masked Image Modeling (MIM)
```
fMRI ì‹œí€€ìŠ¤ â†’ ë§ˆìŠ¤í‚¹ â†’ FMamba â†’ ì¬êµ¬ì„±
Loss = L1/L2(ì¬êµ¬ì„±, ì›ë³¸) * mask
```

#### Contrastive Learning
```
fMRI ì‹œí€€ìŠ¤ â†’ ì¦ê°•1, ì¦ê°•2 â†’ FMamba â†’ ì„ë² ë”©
Loss = NTXent(ì„ë² ë”©1, ì„ë² ë”©2)
```

### 2ï¸âƒ£ ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ (Downstream)

#### Classification
```
fMRI â†’ FMamba â†’ ë¶„ë¥˜ í—¤ë“œ â†’ í´ë˜ìŠ¤ í™•ë¥ 
Loss = CrossEntropy(ì˜ˆì¸¡, íƒ€ê²Ÿ)
Metrics: Accuracy, Balanced Accuracy, AUROC
```

#### Regression
```
fMRI â†’ FMamba â†’ íšŒê·€ í—¤ë“œ â†’ ì—°ì† ê°’
Loss = MSE(ì˜ˆì¸¡, íƒ€ê²Ÿ)
Metrics: MSE, MAE, RÂ², Pearson Correlation
```

---

## ğŸ”§ ì£¼ìš” í•˜ì´í¼íŒŒë¼ë¯¸í„°

### ëª¨ë¸ ê´€ë ¨
| íŒŒë¼ë¯¸í„°          | ê¸°ë³¸ê°’    | ì„¤ëª…                    |
| ----------------- | --------- | ----------------------- |
| `embed_dim`       | 24        | ì„ë² ë”© ì°¨ì› (16ì˜ ë°°ìˆ˜) |
| `depths`          | [12]      | Mamba ë ˆì´ì–´ ìˆ˜         |
| `patch_size`      | [6,6,6,1] | íŒ¨ì¹˜ í¬ê¸° (H,W,D,T)     |
| `mamba_pe_method` | 'nerf'    | ìœ„ì¹˜ ì¸ì½”ë”© ë°©ì‹        |

### í•™ìŠµ ê´€ë ¨
| íŒŒë¼ë¯¸í„°          | ê¸°ë³¸ê°’  | ì„¤ëª…                |
| ----------------- | ------- | ------------------- |
| `learning_rate`   | 1e-3    | í•™ìŠµë¥               |
| `optimizer`       | 'AdamW' | ì˜µí‹°ë§ˆì´ì €          |
| `batch_size`      | 4       | ë°°ì¹˜ í¬ê¸°           |
| `sequence_length` | 20      | ì‹œí€€ìŠ¤ ê¸¸ì´ (TR ìˆ˜) |

### ë°ì´í„° ê´€ë ¨
| íŒŒë¼ë¯¸í„°               | ê¸°ë³¸ê°’   | ì„¤ëª…                 |
| ---------------------- | -------- | -------------------- |
| `input_scaling_method` | 'minmax' | ì…ë ¥ ì •ê·œí™” ë°©ë²•     |
| `stride_between_seq`   | 1.0      | ì‹œí€€ìŠ¤ ê°„ ìŠ¤íŠ¸ë¼ì´ë“œ |

---

## ğŸ“Š ì§€ì› ë°ì´í„°ì…‹

| ë°ì´í„°ì…‹    | ì„¤ëª…                                   | ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ íƒœìŠ¤í¬        |
| ----------- | -------------------------------------- | ------------------------ |
| S1200 (HCP) | Human Connectome Project               | ì„±ë³„, ë‚˜ì´, ì§€ëŠ¥         |
| ABCD        | Adolescent Brain Cognitive Development | ì„±ë³„, ë‚˜ì´, ì§€ëŠ¥         |
| UKB         | UK Biobank                             | ì„±ë³„, ë‚˜ì´, ì§€ëŠ¥, ìš°ìš¸ì¦ |
| HBN         | Healthy Brain Network                  | ì„±ë³„, ë‚˜ì´, ë°œë‹¬ì¥ì•      |
| ABIDE       | Autism Brain Imaging Data Exchange     | ì„±ë³„, ë‚˜ì´, ASD          |
| ADNI        | Alzheimer's Disease Neuroimaging       | AD ì§„ë‹¨, ì „í™˜ ì˜ˆì¸¡       |

---

## ğŸš€ ì‹¤í–‰ ì˜ˆì‹œ

### ì‚¬ì „í•™ìŠµ (Autoregressive)
```bash
python main.py \
  --model fmamba \
  --pretraining \
  --use_autoregressive \
  --embed_dim 128 \
  --depths 12 \
  --sequence_length 40 \
  --batch_size 2 \
  --max_epochs 100
```

### ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ (ì„±ë³„ ë¶„ë¥˜)
```bash
python main.py \
  --model fmamba \
  --downstream_task sex \
  --downstream_task_type classification \
  --load_model_path pretrained_weights.ckpt \
  --embed_dim 128 \
  --clf_head_version mamba
```

---

## ğŸ“ ìš”ì•½

NeuroMambaëŠ” fMRI ë°ì´í„° ë¶„ì„ì„ ìœ„í•œ ì™„ì„±ë„ ë†’ì€ ë”¥ëŸ¬ë‹ í”„ë ˆì„ì›Œí¬ë¡œ:

1. **Mamba2 ì•„í‚¤í…ì²˜**ë¥¼ fMRIì— ì ìš©í•˜ì—¬ ê¸´ ì‹œí€€ìŠ¤ ì²˜ë¦¬ ê°€ëŠ¥
2. **ë‹¤ì–‘í•œ ì‚¬ì „í•™ìŠµ ë°©ë²•** ì§€ì› (Autoregressive, MIM, Contrastive)
3. **ìœ ì—°í•œ ë‹¤ìš´ìŠ¤íŠ¸ë¦¼ íƒœìŠ¤í¬** ì²˜ë¦¬ (ë¶„ë¥˜/íšŒê·€)
4. **ë‹¤ì¤‘ ë°ì´í„°ì…‹** í†µí•© ì§€ì›
5. **ë¶„ì‚° í•™ìŠµ** ì§€ì› (DeepSpeed, MPI)
6. **HDF5 ìµœì í™”**ë¡œ ëŒ€ê·œëª¨ ë°ì´í„° ì²˜ë¦¬ ê°€ëŠ¥


